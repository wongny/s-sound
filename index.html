<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
    <title>Âª£Êù±Ë©±SÈü≥Á∑¥Áøí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f0f9ff; touch-action: manipulation; }
        .mic-active { animation: pulse-red 1s infinite; background-color: #ef4444 !important; }
        @keyframes pulse-red {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const LEVELS = [
            { t: "Èº†", jp: "syu2", img: "üê≠", alt: ["Èº†", "ËÄÅÈº†", "Êõ∏", "Êï∏", "Ëôï", "ÁΩ≤"] },
            { t: "Ê≤ô", jp: "saa1", img: "üèñÔ∏è", alt: ["Ê≤ô", "Â±±", "Ê≤ôÁÅò", "Ë°´", "‰∏â", "Ê≤ôÊ≤ô"] },
            { t: "Ê∞¥", jp: "seoi2", img: "üíß", alt: ["Ê∞¥", "Áù°", "Ê∞¥Êûú"] },
            { t: "Áü≥", jp: "sek6", img: "ü™®", alt: ["Áü≥", "Áü≥È†≠", "Â∏≠", "Â∞Ñ"] },
            { t: "Êâã", jp: "sau2", img: "‚úã", alt: ["Êâã", "ÊâãÈå∂", "È¶ñ"] }
        ];

        function App() {
            const [cur, setCur] = useState(0);
            const [listening, setListening] = useState(false);
            const [heard, setHeard] = useState("");
            const [ok, setOk] = useState(false);
            
            const recog = useRef(null);
            const isManualStop = useRef(false);

            // Ë™ûÈü≥ÂêàÊàêÔºöÁ§∫ÁØÑËÆÄÈü≥
            const speak = (txt) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'zh-HK';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            };

            // Ê†∏ÂøÉÔºöÂàùÂßãÂåñËæ®Ë≠òÂºïÊìé
            const startRecog = () => {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) {
                    alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÔºåË´ã‰ΩøÁî® Chrome");
                    return;
                }

                // ÊØèÊ¨°ÂïüÂãïÈÉΩÂâµÂª∫Êñ∞ÂØ¶‰æãÔºåÈò≤Ê≠¢„ÄåÊ≤íÂèçÊáâ„Äç
                if (recog.current) {
                    try { recog.current.stop(); } catch(e) {}
                }

                const r = new SR();
                r.lang = 'zh-HK';
                r.interimResults = true;
                r.continuous = false; // ÂñÆÂ≠óÁ∑¥ÁøíÁî® false ÈÖçÂêàËá™ÂãïÈáçÂïüÊõ¥ÈùàÊïè

                r.onstart = () => {
                    setListening(true);
                    isManualStop.current = false;
                };

                r.onresult = (e) => {
                    let text = "";
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        text += e.results[i][0].transcript;
                    }
                    setHeard(text);

                    const target = LEVELS[cur];
                    if (text.includes(target.t) || target.alt.some(a => text.includes(a))) {
                        isManualStop.current = true;
                        setListening(false);
                        r.stop();
                        doSuccess();
                    }
                };

                r.onend = () => {
                    // Â¶ÇÊûú‰∏çÊòØÊâãÂãïÂÅúÊ≠¢Ôºå‰πü‰∏çÊòØÊàêÂäüÈÅéÈóúÔºåÂ∞±Ëá™ÂãïÈáçÈÄ£‰∏ÄÊ¨°
                    if (!isManualStop.current && !ok) {
                        try { r.start(); } catch(e) {}
                    } else {
                        setListening(false);
                    }
                };

                r.onerror = (e) => {
                    console.error("Ëæ®Ë≠òÈåØË™§:", e.error);
                    if (e.error === 'not-allowed') alert("Ë´ãÈñãÂïüÈ∫•ÂÖãÈ¢®Ê¨äÈôê");
                    setListening(false);
                };

                recog.current = r;
                try { r.start(); } catch(e) { setListening(false); }
            };

            const doSuccess = () => {
                setOk(true);
                speak("Â•ΩÂèªÂëÄ");
                setTimeout(() => {
                    if (cur < LEVELS.length - 1) {
                        setCur(c => c + 1);
                        setHeard("");
                        setOk(false);
                    } else {
                        alert("ÂÖ®ÈóúÈÅîÊàêÔºÅ");
                        window.location.reload();
                    }
                }, 1500);
            };

            const handleToggle = () => {
                if (listening) {
                    isManualStop.current = true;
                    setListening(false);
                    try { recog.current.stop(); } catch(e) {}
                } else {
                    setHeard("");
                    setOk(false);
                    startRecog();
                }
            };

            const item = LEVELS[cur];

            return (
                <div className="min-h-screen flex flex-col items-center p-6 bg-sky-50 text-slate-800">
                    <div className="w-full max-w-md bg-white p-4 rounded-3xl shadow-sm mb-6 flex justify-between font-bold text-blue-500 border border-blue-100">
                        <span>Á¨¨ {cur + 1} Èóú</span>
                        <span>‚≠ê {cur}</span>
                    </div>

                    <div className={`bg-white rounded-[40px] shadow-lg p-8 w-full max-w-md flex flex-col items-center relative ${ok ? 'ring-8 ring-green-100' : ''}`}>
                        <div className="text-[9rem] mb-2 leading-none">{item.img}</div>
                        <div className="text-7xl font-black mb-1">{item.t}</div>
                        <div className="text-slate-400 text-2xl font-mono mb-8 tracking-widest">{item.jp}</div>

                        <button 
                            onClick={handleToggle}
                            className={`w-full py-8 rounded-3xl text-3xl font-black transition-all text-white shadow-lg active:scale-95 ${listening ? 'mic-active' : 'bg-blue-600'}`}
                        >
                            {listening ? "ËÅΩÁ∑ä‰Ω†Ë¨õ..." : "ÊåâÊ≠§Á∑¥ÁøíËÆÄÈü≥"}
                        </button>

                        <div className="mt-8 text-center min-h-[100px] w-full flex flex-col justify-center bg-slate-50 rounded-2xl p-4">
                            {ok ? (
                                <p className="text-4xl font-black text-green-500 animate-bounce">Ê≠£Á¢∫ÔºÅ</p>
                            ) : (
                                <>
                                    <p className="text-xs font-bold text-slate-400 mb-1 uppercase">Á≥ªÁµ±ËÅΩÂà∞Ôºö</p>
                                    <p className="text-3xl font-black text-red-500">
                                        {heard || (listening ? "Ê≠£Âú®Ëæ®Ë≠ò..." : "Ê∫ñÂÇôÂ•ΩÊú™Ôºü")}
                                    </p>
                                </>
                            )}
                        </div>
                    </div>

                    <button 
                        onClick={() => speak(item.t)}
                        className="mt-8 bg-white border-2 border-blue-100 text-blue-500 px-10 py-4 rounded-2xl font-bold flex items-center gap-2 shadow-sm active:bg-blue-50"
                    >
                        üîà ËÅΩÁ§∫ÁØÑËÆÄÈü≥
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

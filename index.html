<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
    <title>Âª£Êù±Ë©±SÈü≥Á∑¥Áøí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f0f9ff; touch-action: manipulation; }
        .mic-on { background-color: #ef4444 !important; animation: breathe 1.5s infinite; }
        @keyframes breathe { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const LEVELS = [
            { t: "Èº†", jp: "syu2", img: "üê≠", alt: ["ËÄÅÈº†", "Êï∏", "Ëôï", "Êõ∏", "ËñØ"] },
            { t: "Ê≤ô", jp: "saa1", img: "üèñÔ∏è", alt: ["Ê≤ôÁÅò", "‰∏â", "Ë°´", "Â±±"] },
            { t: "Ê∞¥", jp: "seoi2", img: "üíß", alt: ["Ê∞¥Êûú", "Áù°", "Áëû"] },
            { t: "Áü≥", jp: "sek6", img: "ü™®", alt: ["Áü≥È†≠", "Â∏≠", "Â∞Ñ"] },
            { t: "Êâã", jp: "sau2", img: "‚úã", alt: ["ÊâãÈå∂", "È¶ñ"] }
        ];

        function App() {
            const [cur, setCur] = useState(0);
            const [isListening, setIsListening] = useState(false);
            const [heard, setHeard] = useState("");
            const [error, setError] = useState("");
            const recognitionRef = useRef(null);

            const speak = (txt) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = 'zh-HK';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            };

            const startListening = () => {
                // 1. Ê∏ÖÈô§ËàäÈåØË™§ËàáÁãÄÊÖã
                setError("");
                setHeard("");

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    setError("‰Ω†ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊåÅË™ûÈü≥ÂäüËÉΩ");
                    return;
                }

                // 2. ÂâµÂª∫ÂØ¶‰æã (ÊØèÊ¨°ÈªûÊìäÈÉΩÈáçÊñ∞ÂâµÂª∫ÊúÄ‰øùÈö™)
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-HK';
                recognition.interimResults = true;
                recognition.continuous = false;

                recognition.onstart = () => {
                    setIsListening(true);
                };

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    setHeard(transcript);

                    const target = LEVELS[cur];
                    if (transcript.includes(target.t) || target.alt.some(a => transcript.includes(a))) {
                        recognition.stop();
                        handleSuccess();
                    }
                };

                recognition.onerror = (event) => {
                    setError("Âá∫ÈåØ: " + event.error);
                    setIsListening(false);
                };

                recognition.onend = () => {
                    setIsListening(false);
                };

                recognitionRef.current = recognition;
                try {
                    recognition.start();
                } catch (e) {
                    setError("ÂïüÂãïÂ§±ÊïóÔºåË´ãÈáçË©¶");
                    setIsListening(false);
                }
            };

            const handleSuccess = () => {
                speak("Â•ΩÂèªÂëÄ");
                setTimeout(() => {
                    setCur(c => (c + 1) % LEVELS.length);
                    setHeard("");
                    setError("");
                }, 1500);
            };

            const item = LEVELS[cur];

            return (
                <div className="min-h-screen flex flex-col items-center p-6 text-slate-800">
                    <div className="w-full max-w-md bg-white p-4 rounded-2xl shadow-sm mb-6 flex justify-between font-bold text-blue-500">
                        <span>ÈóúÂç° {cur + 1}</span>
                        <span>‚≠ê {cur}</span>
                    </div>

                    <div className="bg-white rounded-[40px] shadow-lg p-10 w-full max-w-md flex flex-col items-center">
                        <div className="text-[10rem] mb-4">{item.img}</div>
                        <div className="text-8xl font-black mb-2">{item.t}</div>
                        <p className="text-slate-400 text-2xl mb-10">{item.jp}</p>

                        <button 
                            onClick={startListening}
                            disabled={isListening}
                            className={`w-full py-8 rounded-3xl text-3xl font-black text-white transition-all ${isListening ? 'mic-on' : 'bg-blue-600 active:bg-blue-700 shadow-xl'}`}
                        >
                            {isListening ? "Ê≠£Âú®ËÅΩ‰Ω†Ë¨õ..." : "ÊåâÊ≠§ÈñãÂßãÁ∑¥Áøí"}
                        </button>

                        <div className="mt-8 text-center min-h-[80px]">
                            {error ? (
                                <p className="text-red-500 font-bold">{error}</p>
                            ) : (
                                <p className="text-3xl font-black text-blue-500">{heard || "---"}</p>
                            )}
                        </div>
                    </div>

                    <button onClick={() => speak(item.t)} className="mt-10 text-blue-500 font-bold underline text-xl">
                        üîà ËÅΩÁ§∫ÁØÑËÆÄÈü≥
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
